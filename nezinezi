// ==UserScript==
// @name         ã­ã˜ã­ã˜è±Šãã‚“ v3
// @namespace    http://tampermonkey.net/
// @version      6.00
// @description  JRAå¸­è‡ªå‹•é¸æŠï¼‹é€šçŸ¥ï¼‹åˆ†ã¯5ã®å€æ•°å›ºå®šãƒ»ç§’ã¯ä»»æ„æŒ‡å®šæ›´æ–°æ©Ÿèƒ½ä»˜ã
// @match        https://jra-tickets.jp/SeatKindSelect*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  // === è¨­å®š ===
  const SEAT_PAIRS = [
    { block: 2, amount: 2 }, // { block: å¸­ID, amount: äººæ•° } â€»ã‚¨ãƒ«ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«(8)ã¯äººæ•°4ã§å›ºå®š
    { block: 3, amount: 1 }, //ä¸Šã‹ã‚‰å–ã‚ŠãŸã„å¸­ã®å„ªå…ˆé †ã«
  ];

  const WAIT_MS_AFTER_CLICK = 0;

  // --- é€šçŸ¥æ©Ÿèƒ½è¨­å®š ---
  const ENABLE_NOTIFICATION = false;  // trueã§é€šçŸ¥ONã€falseã§é€šçŸ¥OFF
  const PUSHOVER_USER_KEY = ''; // ã‚ãªãŸã®Pushoverãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ¼
  const PUSHOVER_APP_TOKEN = ''; // ã‚ãªãŸã®Pushoverã‚¢ãƒ—ãƒªãƒˆãƒ¼ã‚¯ãƒ³

  // --- æ›´æ–°æ©Ÿèƒ½è¨­å®š ---
  const ENABLE_AUTO_RELOAD = false;   // trueã§æ›´æ–°æ©Ÿèƒ½ONã€falseã§OFF
  const RELOAD_SECONDS_OFFSET = 5;   // ç§’æ•°ã®ã‚ºãƒ¬(sec)

  const DEBUG = true;

  let currentIndex = 0;
  let observer = null;
  let reloadTimerId = null;

  // === ãƒ­ã‚°é–¢æ•° ===
  function log(...args) {
    if (DEBUG) console.log('[JRA Script]', ...args);
  }

  // === é€šçŸ¥é€ä¿¡é–¢æ•° ===
  function sendPushoverNotification(message) {
    if (!ENABLE_NOTIFICATION) {
      log('[é€šçŸ¥] ğŸ”• é€šçŸ¥æ©Ÿèƒ½OFFã®ãŸã‚é€ä¿¡ãªã—');
      return;
    }
    if (!PUSHOVER_USER_KEY || !PUSHOVER_APP_TOKEN) {
      log('[é€šçŸ¥] ğŸ”• Pushoverã‚­ãƒ¼æœªè¨­å®š');
      return;
    }

    const data = new URLSearchParams({
      token: PUSHOVER_APP_TOKEN,
      user: PUSHOVER_USER_KEY,
      message,
    });

    fetch('https://api.pushover.net/1/messages.json', {
      method: 'POST',
      body: data,
    })
      .then(res => res.ok ? res.json() : Promise.reject(res.status))
      .then(json => log('[é€šçŸ¥] Pushoveré€ä¿¡æˆåŠŸ', json))
      .catch(err => console.error('[é€šçŸ¥] âŒ Pushoveré€ä¿¡å¤±æ•—:', err));
  }

  // === ç›£è¦–ã¨ã‚¿ã‚¤ãƒãƒ¼åœæ­¢é–¢æ•° ===
  function stopScript() {
    if (observer) {
      observer.disconnect();
      observer = null;
      log('ğŸ›‘ ç›£è¦–åœæ­¢');
    }
    if (reloadTimerId !== null) {
      clearInterval(reloadTimerId);
      reloadTimerId = null;
      log('ğŸ›‘ è‡ªå‹•æ›´æ–°ã‚¿ã‚¤ãƒãƒ¼åœæ­¢');
    }
  }

  // === å¸Œæœ›å¸­æ•°é¸æŠå‡¦ç† ===
  function selectSeatAmount(seatBlockIndex, desiredAmount) {
    const selectorPrefix = `input[type="hidden"][id^="Main_SeatListItemRepeater_SeatListItem_${seatBlockIndex}_SeatAmountRepeater_${seatBlockIndex}_SeatAmountLinkButton_"]`;
    const allInputs = document.querySelectorAll(selectorPrefix);

    for (const input of allInputs) {
      if (parseInt(input.value, 10) === desiredAmount) {
        const seatLink = input.closest('li')?.querySelector('a');
        if (seatLink) {
          seatLink.click();
          log(`âœ… ãƒ–ãƒ­ãƒƒã‚¯${seatBlockIndex} - ${desiredAmount}å¸­ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã—ãŸ`);
          sendPushoverNotification(`ğŸ« ãƒ–ãƒ­ãƒƒã‚¯${seatBlockIndex}ã§${desiredAmount}å¸­ã‚’è‡ªå‹•é¸æŠã—ã¾ã—ãŸ`);
          stopScript(); // é¸æŠæˆåŠŸã§ç›£è¦–ãƒ»æ›´æ–°åœæ­¢
          return true;
        }
      }
    }
    log(`â— ãƒ–ãƒ­ãƒƒã‚¯${seatBlockIndex} - ${desiredAmount}å¸­ã®ãƒªãƒ³ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    return false;
  }

  // === æ¬¡ã®ãƒšã‚¢ã‚’è©¦ã™å‡¦ç† ===
  function tryNextPair() {
    if (currentIndex >= SEAT_PAIRS.length) {
      log('âŒ å…¨ãƒšã‚¢è©¦ã—ã¾ã—ãŸãŒç©ºããªã—');
      return;
    }

    const { block, amount } = SEAT_PAIRS[currentIndex];
    log(`ğŸ” è©¦è¡Œä¸­: ãƒ–ãƒ­ãƒƒã‚¯=${block}, å¸­æ•°=${amount}`);

    const panel = document.querySelector(`#Main_SeatListItemRepeater_SeatListItem_${block}_PnlAutoSelectButton_${block}`);

    if (panel && panel.offsetParent !== null) {
      const label = panel.querySelector('label.btn_01');
      if (label && !label.classList.contains('btn_off')) {
        label.click();
        setTimeout(() => {
          if (!selectSeatAmount(block, amount)) {
            currentIndex++;
            tryNextPair();
          }
        }, WAIT_MS_AFTER_CLICK);
        return;
      }
    }

    log(`â›” ãƒ–ãƒ­ãƒƒã‚¯${block}ã¯æŠ¼ã›ãªã„çŠ¶æ…‹ â†’ æ¬¡ã®ãƒšã‚¢ã¸`);
    currentIndex++;
    tryNextPair();
  }

  // === ãƒœã‚¿ãƒ³ã®å¤‰åŒ–ã‚’ç›£è¦–ã—è©¦è¡Œã™ã‚‹å‡¦ç† ===
  function watchAutoSelectButton() {
    observer = new MutationObserver(() => {
      tryNextPair();
    });
    observer.observe(document.body, { childList: true, subtree: true });
    log('â±ï¸ ãƒœã‚¿ãƒ³ç›£è¦–é–‹å§‹');
  }

  // === 5åˆ†ã”ã¨ï¼ˆåˆ†ã¯5ã®å€æ•°å›ºå®šã€ç§’ã¯ä»»æ„æŒ‡å®šï¼‰ã«ãƒšãƒ¼ã‚¸æ›´æ–° ===
  function startReloadWatcher() {
    if (!ENABLE_AUTO_RELOAD) {
      log('[JRA Script] ğŸ”• è‡ªå‹•æ›´æ–°æ©Ÿèƒ½OFFã®ãŸã‚é–‹å§‹ã—ã¾ã›ã‚“');
      return;
    }
    log(`[JRA Script] â±ï¸ è‡ªå‹•æ›´æ–°ç›£è¦–é–‹å§‹ åˆ†ã¯5ã®å€æ•°ã€ç§’ã¯${RELOAD_SECONDS_OFFSET}ç§’`);

    reloadTimerId = setInterval(() => {
      const now = new Date();
      const mm = now.getMinutes();
      const ss = now.getSeconds();

      // mmãŒ5ã®å€æ•°ã‹ã¤ç§’ãŒRELOAD_SECONDS_OFFSETãªã‚‰æ›´æ–°
      if (mm % 5 === 0 && ss === RELOAD_SECONDS_OFFSET) {
        const url = window.location.href;
        log(`[JRA Script] ğŸªŸ è‡ªå‹•æ›´æ–°å®Ÿè¡Œ â†’ ${url}`);

        const newWindow = window.open(url, '_blank');

        if (newWindow) {
          window.close();
        } else {
          console.warn('[JRA Script] âŒ è‡ªå‹•æ›´æ–°ã«å¤±æ•—ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒ–ãƒ­ãƒƒã‚¯ã®å¯èƒ½æ€§ï¼‰');
        }
      }
    }, 1000);
  }

  // === åˆæœŸåŒ–å‡¦ç† ===
  function init() {
    log('åˆæœŸåŒ–é–‹å§‹');
    watchAutoSelectButton();
    tryNextPair();
    startReloadWatcher();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
